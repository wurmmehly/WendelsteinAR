<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Wendelstein Digital - Location
    </title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
    <script>
        // Model vor Kamera
        AFRAME.registerComponent("place-in-front-of-camera", {
            schema: {
                type: "number",
                default: 1
            },
            tick: function () {
                if (!this.el.sceneEl.renderStarted) return;
                const camera = this.el.sceneEl.camera;
                if (!camera) return;
                const offset = new THREE.Vector3(0, -0.5, -this.data);
                camera.localToWorld(offset);
                this.el.object3D.position.copy(offset);
            }
        });

        // Haversine - Entfernung
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = x => x * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        window.addEventListener('DOMContentLoaded', () => {
            const ziel1 = {
                lat: 48.75024175713993, //Testing
                lon: 11.430444728664085
            };
            const ziel2 = {
                lat: 48.75015395289849, //Testing
                lon: 11.429551003591685
            };
            const radius = 10; // Meter

            const model1 = document.querySelector('#modell1');
            const model2 = document.querySelector('#modell2');

            document.querySelector('[gps-new-camera]').addEventListener('gps-camera-update-position', function (
                e) {
                const userLat = e.detail.position.latitude;
                const userLon = e.detail.position.longitude;

                // Beide Modelle zun√§chst unsichtbar machen
                model1.setAttribute('visible', false);
                model2.setAttribute('visible', false);

                const dist1 = getDistance(userLat, userLon, ziel1.lat, ziel1.lon);
                const dist2 = getDistance(userLat, userLon, ziel2.lat, ziel2.lon);

                if (dist1 < radius) model1.setAttribute('visible', true);
                if (dist2 < radius) model2.setAttribute('visible', true);
            });
        });
    </script>
</head>

<body style="margin: 0; overflow: hidden">
    <a-scene vr-mode-ui="enabled: false" arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false"
        renderer="antialias: true; alpha: true" gltf-model="dracoDecoderPath: draco/;" loading-screen="enabled: false">
        <a-assets>
            <a-asset-item id="fraunhofer" src="models/fraunhofer/fraunhofer.glb"></a-asset-item>
        </a-assets>
        <a-camera gps-new-camera="gpsMinDistance: 1">
        </a-camera>

        <a-entity id="modell1" gltf-model="#fraunhofer" scale="0.05 0.05 0.05" visible="false"
            place-in-front-of-camera="8">
        </a-entity>

        <a-box id="modell2" color="blue" depth="0.5" height="0.5" width="0.5" visible="false"
            place-in-front-of-camera="1.5">
        </a-box>
    </a-scene>
</body>

</html>